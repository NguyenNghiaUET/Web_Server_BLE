<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>ESP32 BLE LED Control</title>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; margin-top: 40px; }
    h1 { color: #333; }
    button { 
      padding: 14px 28px; 
      margin: 15px; 
      font-size: 18px; 
      border-radius: 10px; 
      cursor: pointer; 
      border: none;
    }
    #connectBtn { background: #007BFF; color: white; }
    #ledToggle { background: gray; color: white; }
    #status { margin-top: 20px; font-weight: bold; }
    #log { margin-top: 20px; white-space: pre-line; text-align: left; display: inline-block; background: #f9f9f9; padding: 12px; border-radius: 8px; width: 60%; }
  </style>
</head>
<body>
  <h1>ESP32 Web Bluetooth</h1>
  <button id="connectBtn">üîó K·∫øt n·ªëi ESP32</button>
  <button id="ledToggle" disabled>üí° B·∫≠t LED</button>

  <p id="status">Ch∆∞a k·∫øt n·ªëi</p>
  <div id="log"></div>

  <script>
    const connectBtn = document.getElementById("connectBtn");
    const ledToggleBtn = document.getElementById("ledToggle");
    const status = document.getElementById("status");
    const logBox = document.getElementById("log");

    let ledCharacteristic;
    let ledState = false; // false = OFF, true = ON

    function log(msg) {
      logBox.textContent += msg + "\n";
    }

    connectBtn.addEventListener("click", async () => {
      try {
        const device = await navigator.bluetooth.requestDevice({
          filters: [{ namePrefix: "ESP32" }],
         optionalServices: ["battery_service"]

        });

        status.textContent = `ƒê√£ ch·ªçn: ${device.name}`;
        log(`üîó K·∫øt n·ªëi t·ªõi ${device.name}...`);

        const server = await device.gatt.connect();
        status.textContent = `‚úÖ ƒê√£ k·∫øt n·ªëi t·ªõi ${device.name}`;
        log("GATT connected");


const service = await server.getPrimaryService("battery_service");

        // Battery service demo
      const batteryChar = await service.getCharacteristic(0x2A19);

        const val = await batteryChar.readValue();
        log(`üîã Pin ESP32: ${val.getUint8(0)}%`);

        // LED characteristic
        ledCharacteristic = await service.getCharacteristic("12345678-1234-1234-1234-1234567890ab");
        log("üí° LED characteristic ready");

        ledToggleBtn.disabled = false;
      } catch (err) {
        console.error(err);
        status.textContent = "‚ùå L·ªói: " + err;
        log("‚ùå " + err);
      }
    });

    ledToggleBtn.addEventListener("click", async () => {
      if (ledCharacteristic) {
        ledState = !ledState; // ƒë·∫£o tr·∫°ng th√°i
        const cmd = ledState ? "1" : "0";
        await ledCharacteristic.writeValue(new TextEncoder().encode(cmd));
        log(ledState ? "üí° LED ON" : "‚ùå LED OFF");

        // ƒë·ªïi m√†u n√∫t
        ledToggleBtn.textContent = ledState ? "‚ùå T·∫Øt LED" : "üí° B·∫≠t LED";
        ledToggleBtn.style.background = ledState ? "red" : "green";
      }
    });
  </script>
</body>
</html>
